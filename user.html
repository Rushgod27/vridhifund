<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #e0f7fa, #e1bee7);
      color: #333;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #4a148c;
      margin-bottom: 30px;
    }
    section, .card {
      background: #ffffffdd;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
      transition: transform 0.3s ease;
    }
    section:hover, .card:hover {
      transform: scale(1.01);
    }
    h2 {
      color: #6a1b9a;
      border-bottom: 2px solid #ba68c8;
      padding-bottom: 5px;
      margin-bottom: 15px;
    }
    input, button, select {
      padding: 8px 12px;
      margin: 5px 4px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    input:focus, button:focus {
      outline: none;
      border-color: #ab47bc;
    }
    button {
      background-color: #ab47bc;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #8e24aa;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #6a1b9a;
      color: white;
    }
    .pagination {
      margin-top: 20px;
      text-align: center;
    }
    .pagination button {
      padding: 8px 16px;
      margin: 5px;
    }
    @media (max-width: 600px) {
      section, .card {
        padding: 15px;
      }
      input, button, select {
        width: 100%;
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <h1>User Dashboard</h1>

  <div class="card">
    <h2>Total Vridhi Funds: ₹<span id="totalFunds">Loading...</span></h2>
  </div>

  <div class="card">
    <h2>Loan Eligible Amount: ₹<span id="eligibleAmount">Loading...</span></h2>
  </div>

  <div class="card">
    <h2>Apply for Loan</h2>
    <input type="text" id="loggedInUsername" readonly />
    <input type="number" id="loanAmount" placeholder="Enter amount" oninput="updateFinalAmount()" />
    <select id="loanTenure" onchange="updateFinalAmount()">
      <option value="15">15 days</option>
      <option value="30">30 days</option>
      <option value="45">45 days</option>
      <option value="60">60 days</option>
    </select>
    <button onclick="applyForLoan()">Apply</button>
    <p id="loanApplyMessage"></p>
    <p id="finalAmountMessage" style="color: #4a148c; margin-top: 10px;"></p>
  </div>

  <div class="card">
    <h2>Loan History</h2>
    <div style="margin-bottom: 10px;">
      <input type="text" id="loanSearch" placeholder="Search by status/date/amount..." oninput="loadLoanHistory()" />
      <select id="loanSort" onchange="loadLoanHistory()">
        <option value="date_desc">Newest First</option>
        <option value="date_asc">Oldest First</option>
        <option value="amount_asc">Amount Low to High</option>
        <option value="amount_desc">Amount High to Low</option>
      </select>
    </div>
    <table>
    <thead>
  <tr>
    <th>Loan ID</th>
    <th>Amount</th>
    <th>Status</th>
    <th>Loan Request Date</th>
    <th>Tenure (Days)</th>
    <th>Loan Approved Date</th>
    <th>Due Date</th>
    <th>overdue fine</th> <!-- New -->
    <th>Total Amount to Repay</th> <!-- New -->
<th>Take Action</th> <!-- New -->

  </tr>
</thead>


      <tbody id="loanHistoryTable"></tbody>
    </table>
    <div class="pagination">
      <button onclick="prevPage()">Previous</button>
      <button onclick="nextPage()">Next</button>
      <p id="paginationInfo"></p>
    </div>
    <div class="card">
      <h2>Download Loan History</h2>
      <button onclick="downloadPDF()">Download PDF</button>
      <button onclick="downloadExcel()">Download Excel</button>
      <button onclick="downloadCSV()">Download CSV</button>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD_APjfMpyaTsK1F3w9VbJA_ujT666oklM",
    authDomain: "vridhi-funds.firebaseapp.com",
    projectId: "vridhi-funds",
    storageBucket: "vridhi-funds.firebasestorage.app",
    messagingSenderId: "925637396313",
    appId: "1:925637396313:web:ce3911ed3f626f31726e48"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser;
  let loanDataArray = [];
  let currentPage = 1;
  const rowsPerPage = 5;

  auth.onAuthStateChanged(async user => {
    if (!user) {
      alert("Not logged in");
      return;
    }
    currentUser = user;
    document.getElementById('loggedInUsername').value = user.email;
    await loadDashboard();
    await updateOverdueFinesInFirestore();
  });

  async function loadDashboard() {
    const usersSnap = await db.collection("users").get();
    let totalUserBalance = 0;
    usersSnap.forEach(doc => {
      totalUserBalance += doc.data().balance || 0;
    });

    const approvedLoansSnap = await db.collection("loans").where("status", "==", "approved").get();
    let approvedDistributableAmount = 0;
    approvedLoansSnap.forEach(doc => {
      approvedDistributableAmount += doc.data().finalCredited || 0;
    });

    const recoveriesSnap = await db.collection("recoveries").get();
    let recovered = 0;
    recoveriesSnap.forEach(doc => {
      recovered += (doc.data().amount || 0) + (doc.data().fine || 0);
    });

    const totalFunds = totalUserBalance + recovered - approvedDistributableAmount;
    document.getElementById("totalFunds").textContent = totalFunds.toFixed(2);

    const eligible = totalFunds * 0.33;
    document.getElementById("eligibleAmount").textContent = eligible.toFixed(2);

    await fetchLoanHistory();
  }

  async function updateOverdueFinesInFirestore() {
    const loansSnap = await db.collection("loans")
      .where("user", "==", currentUser.email)
      .get();

    const now = new Date();

    for (const doc of loansSnap.docs) {
      const data = doc.data();

      if (data.status !== "approved" || !data.approvalTimestamp) continue;

      const approvalDate = new Date(data.approvalTimestamp.seconds * 1000);
      const dueDate = new Date(approvalDate);
      dueDate.setDate(dueDate.getDate() + data.tenure);

      if (now > dueDate) {
        const overdueDays = Math.floor((now - dueDate) / (1000 * 60 * 60 * 24));
        const fine = overdueDays * 50;
        const totalRepay = (data.finalCredited || 0) + fine;

        if (data.overdueFine !== fine || data.totalRepay !== totalRepay) {
          await db.collection("loans").doc(doc.id).update({
            overdueFine: fine,
            totalRepay: totalRepay
          });
        }
      }
    }

    await fetchLoanHistory(); // Reload with updated fines
  }

  function updateFinalAmount() {
    const amountInput = document.getElementById("loanAmount").value;
    const tenure = parseInt(document.getElementById("loanTenure").value);
    const amount = parseFloat(amountInput);
    const finalMsg = document.getElementById("finalAmountMessage");

    if (!amount || amount <= 0 || isNaN(tenure)) {
      finalMsg.textContent = "";
      return;
    }

    let feePercentage = 0;
    switch (tenure) {
      case 15: feePercentage = 0.01; break;
      case 30: feePercentage = 0.02; break;
      case 45: feePercentage = 0.03; break;
      case 60: feePercentage = 0.04; break;
      default: feePercentage = 0.02;
    }

    const fee = amount * feePercentage;
    const finalAmount = amount - fee;

    finalMsg.textContent = `Tenure: ${tenure} days. Fee: ₹${fee.toFixed(2)} (${(feePercentage * 100).toFixed(0)}%). Final credited amount: ₹${finalAmount.toFixed(2)}.`;
  }

  async function applyForLoan() {
    const amount = parseFloat(document.getElementById("loanAmount").value);
    const tenure = parseInt(document.getElementById("loanTenure").value);
    const eligible = parseFloat(document.getElementById("eligibleAmount").textContent);
    const msg = document.getElementById("loanApplyMessage");
    msg.textContent = "";

    if (isNaN(amount) || amount <= 0) {
      msg.textContent = "Invalid amount.";
      return;
    }
    if (amount > eligible) {
      msg.textContent = `Amount exceeds eligible limit.`;
      return;
    }

    let feePercentage = 0;
    switch (tenure) {
      case 15: feePercentage = 0.01; break;
      case 30: feePercentage = 0.02; break;
      case 45: feePercentage = 0.03; break;
      case 60: feePercentage = 0.04; break;
    }

    const finalCredited = amount - (amount * feePercentage);
    const now = new Date();

    await db.collection("loans").add({
      user: currentUser.email,
      amount,
      tenure,
      status: "pending",
      finalCredited,
      requestDate: now.toLocaleString("en-IN", {
        timeZone: "Asia/Kolkata",
        year: "numeric",
        month: "long",
        day: "numeric",
        hour: "numeric",
        minute: "numeric",
        second: "numeric",
        hour12: true,
        timeZoneName: "short"
      })
    });

    msg.textContent = `Loan application submitted for ₹${amount.toFixed(2)}.`;
    await fetchLoanHistory();
  }

  async function fetchLoanHistory() {
    const loansSnap = await db.collection("loans").where("user", "==", currentUser.email).get();
    loanDataArray = loansSnap.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      timestamp: doc.data().requestDate ? new Date(doc.data().requestDate) : new Date(),
    }));
    loadLoanHistory();
  }

  function loadLoanHistory() {
    const filterText = document.getElementById("loanSearch").value.toLowerCase();
    const sortedData = sortLoans(loanDataArray, document.getElementById("loanSort").value);
    const filteredData = sortedData.filter(item =>
      item.status.toLowerCase().includes(filterText) ||
      item.amount.toString().includes(filterText) ||
      item.requestDate.toLowerCase().includes(filterText)
    );
    renderLoanHistory(filteredData);
  }

  function sortLoans(data, sortBy) {
    switch (sortBy) {
      case 'date_desc': return data.sort((a, b) => b.timestamp - a.timestamp);
      case 'date_asc': return data.sort((a, b) => a.timestamp - b.timestamp);
      case 'amount_asc': return data.sort((a, b) => a.amount - b.amount);
      case 'amount_desc': return data.sort((a, b) => b.amount - a.amount);
      default: return data;
    }
  }
function renderLoanHistory(filteredData) {
  const tableBody = document.getElementById("loanHistoryTable");
  tableBody.innerHTML = "";
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const paginated = filteredData.slice(start, end);

  paginated.forEach(data => {
    let approvalDate = data.approvalTimestamp 
      ? new Date(data.approvalTimestamp.seconds * 1000)
      : null;

    let dueDate = approvalDate
      ? new Date(approvalDate.getTime())
      : new Date(data.timestamp); // fallback to request date if not approved

    dueDate.setDate(dueDate.getDate() + data.tenure);

    // Calculate fine (₹50 per day after due date) only if loan is approved
    let fine = 0;
    if (data.status === "approved" && new Date() > dueDate) {
      const overdueDays = Math.floor((new Date() - dueDate) / (1000 * 60 * 60 * 24));
      fine = overdueDays * 50;
    }

    const totalRepay = data.amount + fine;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${data.id}</td>
      <td>₹${data.amount.toFixed(2)}</td>
      <td>${data.status}</td>
      <td>${data.requestDate}</td>
      <td>${data.tenure} days</td>
      <td>${approvalDate ? approvalDate.toLocaleString("en-IN", { timeZone: "Asia/Kolkata" }) : "N/A"}</td>
      <td>${dueDate.toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })}</td>
      <td>${data.status === "approved" ? `₹${fine.toFixed(2)}` : "-"}</td>
      <td>${data.status === "approved" ? `₹${totalRepay.toFixed(2)}` : "-"}</td>
      <td>
        ${data.status === "approved"
          ? `<button onclick="requestRepayment('${data.id}', ${data.amount}, ${fine})">Repay</button>`
          : ""}
      </td>
    `;
    tableBody.appendChild(row);
  });

  document.getElementById("paginationInfo").textContent =
    `Page ${currentPage} of ${Math.ceil(filteredData.length / rowsPerPage)}`;
}

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      loadLoanHistory();
    }
  }

  function nextPage() {
    const totalPages = Math.ceil(loanDataArray.length / rowsPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      loadLoanHistory();
    }
  }

  function downloadPDF() {
    const doc = new jsPDF();
    doc.text("Loan History", 20, 10);
    doc.autoTable({ html: "#loanHistoryTable" });
    doc.save("loan_history.pdf");
  }

  function downloadExcel() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(document.querySelector("table"));
    XLSX.utils.book_append_sheet(wb, ws, "Loan History");
    XLSX.writeFile(wb, "loan_history.xlsx");
  }

  function downloadCSV() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(document.querySelector("table"));
    XLSX.utils.book_append_sheet(wb, ws, "Loan History");
    const csv = XLSX.utils.sheet_to_csv(ws);
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
    link.download = "loan_history.csv";
    link.click();
  }
async function requestRepayment(loanId, amount, fine) {
  if (!confirm(`Confirm repayment request for ₹${amount + fine}?`)) return;

  const now = new Date();
  try {
    await db.collection("repaymentRequests").add({
      loanId,
      user: currentUser.email,
      amountPaid: amount,
      finePaid: fine,
      totalPaid: amount + fine,
      status: "pending",
      requestDate: now.toLocaleString("en-IN", {
        timeZone: "Asia/Kolkata",
        year: "numeric",
        month: "long",
        day: "numeric",
        hour: "numeric",
        minute: "numeric",
        second: "numeric",
        hour12: true,
        timeZoneName: "short"
      })
    });
    alert("Repayment request sent to manager for confirmation.");
  } catch (err) {
    console.error("Repayment request failed:", err);
    alert("Error sending repayment request.");
  }
}

</script>


</body> </html>
